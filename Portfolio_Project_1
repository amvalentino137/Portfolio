/*
Covid 19 Data Exploration 
Skills used: Joins, CTE's, Temp Tables, Windows Functions, Aggregate Functions, Creating Views, Converting Data Types
*/

SELECT
  *
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
WHERE
  continent IS NOT NULL
ORDER BY
  3,
  4
  --`This code shows those in the US died when they contracted Covid`
SELECT
  location,
  date,
  total_cases,
  total_deaths,
  ((total_deaths/total_cases)*100) AS DeathPercentage
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
WHERE
  location = "United States"
ORDER BY
  1,
  2
  --`This code shows what percentage of the US population got covid`
SELECT
  location,
  date,
  population,
  total_cases,
  ((total_cases/population)*100) AS PercentPopulationInfected
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
WHERE
  location = "United States"
ORDER BY
  1,
  2
  --`Looking at Countries with Highest Infection Rates compared to population`
SELECT
  location,
  population,
  MAX(total_cases) AS HighestInfectionCount,
  MAX((total_cases/population)*100) AS PercentPopulationInfected
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
  --Where location like '%states%'
GROUP BY
  location,
  population
ORDER BY
  PercentPopulationInfected DESC
  --Showing Countries with Highest Death Count per Population
SELECT
  location,
  MAX(CAST(total_deaths AS int64)) AS TotalDeathCount
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
  --Where location like '%states%'
WHERE
  continent IS NOT NULL
GROUP BY
  location
ORDER BY
  TotalDeathCount DESC
  
  
  --Let's break things down by continents


SELECT
  location,
  MAX(CAST(total_deaths AS int64)) AS TotalDeathCount
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
  --Where location like '%states%'
WHERE
  continent IS NULL
GROUP BY
  location
ORDER BY
  TotalDeathCount DESC
  --Showing continents with the highest death count per population
SELECT
  continent,
  MAX(CAST(total_deaths AS int64)) AS TotalDeathCount
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
  --Where location like '%states%'
WHERE
  continent IS NOT NULL
GROUP BY
  continent
ORDER BY
  TotalDeathCount DESC
  -- Global Numbers
SELECT
  SUM(new_cases) AS total_cases,
  SUM(CAST(new_deaths AS int64)) AS total_deaths,
  SUM(CAST(new_deaths AS int64))/(SUM(new_cases)*100) AS DeathPercentage
FROM
  `sql-data-exploration-340900.covid_info.covid_deaths`
  --Where location like `%states%`
WHERE
  continent IS NOT NULL
--GROUP BY date
ORDER BY
  1,2

  --USE CTE
 With PopvsVac (Continent,Location,Date,Population,New_Vaccinations,RollingPeopleVaccinated) 
 as  
(SELECT dea.continent,dea.location,dea.date,dea.population, vac.new_vaccinations,Sum(cast(vac.new_vaccinations as int64)) OVER(PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated --,(RollingPeopleVaccinated/population)*100
  FROM`sql-data-exploration-340900.covid_info.covid_deaths` dea
  JOIN`sql-data-exploration-340900.covid_info.covid_vaccinations` vac
  ON dea.location = vac.location AND dea.date = vac.date
  WHERE dea.continent IS NOT NULL
  --order by 2,3 )

 SELECT * , (RollingPeopleVaccinated/population)*100
 FROM PopvsVac

  --Temp table
drop table if exists #PercentPopulationVaccinated
Create Table #RollingPeopleVaccinated
(
Continent nvarchar(255)
Location nvarchar(255),
date datetime,
Population numeric,
New_vaccinations numeric,
RollingPeopleVaccinated numeric)
  INSERT INTO #PercentPopulationVaccinated
  SELECT dea.continent,dea.location,dea.date,dea.population, vac.new_vaccinations, SUM(CAST(vac.new_vaccinations AS int64)) OVER(PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated --,(RollingPeopleVaccinated/population)*100
  FROM
    `sql-data-exploration-340900.covid_info.covid_deaths` dea
  JOIN
    `sql-data-exploration-340900.covid_info.covid_vaccinations` vac
  ON dea.location = vac.location AND dea.date = vac.date
  WHERE --dea.continent IS NOT NULL
    --order by 2,3)

    SELECT * , (RollingPeopleVaccinated/Population)*100
FROM #PercentPopulationVaccinated


  --Creating View to store data for later visualization

 Create View new_vaccinations as 
 SELECT dea.continent,dea.location,dea.date,dea.population,vac.new_vaccinations,SUM(CAST(vac.new_vaccinations AS int64)) OVER(PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated --,(RollingPeopleVaccinated/population)*100
  FROM `sql-data-exploration-340900.covid_info.covid_deaths` dea
  JOIN`sql-data-exploration-340900.covid_info.covid_vaccinations` vac
  ON dea.location = vac.location AND dea.date = vac.date
  WHERE dea.continent IS NOT NULL
  order by 2,3
